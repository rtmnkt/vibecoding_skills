# タスクスキル 新規作成指示書

## 概要

独立したコンテキストで作業を最後まで完了させるためのスキルを新規作成する。

## 背景

Claude Codeでの開発において以下の問題がある:

1. **コンテキスト汚染**: 1つの会話セッションで長く続けるとトークンコストが嵩む
2. **過去会話への引っ張られ**: 「客観的に意見して」としてもモデル特性で過去会話に影響される
3. **不要情報の蓄積**: ツール呼び出しや関係ない話で会話履歴が膨らむ

## 目的

- 並列化されても独立して安定して独走できる環境の用意
- ガードレール（信頼ベース、将来的に機械的）

## 依存関係

```
タスクスキル → async-shell
```

プロジェクト駆動スキルは任意参照（開発作業時に使う判断になる場合）。

## ワークフロー

### 基本フロー

```
1. 指示X → タスク作成 → CC終了
2. 新CC → タスクでプラン対話 → 計画確定（指示者がOKと言ったら）
3. 新CC → サブタスク実行 → 完了 → タスク更新
4. タスク完了
```

### 異常発生時

```
1-3. 同上
4. 新CC → サブタスク実行中に問題発覚
   → サブタスクに記録、タスクに「計画要修正」フラグ
5. 新CC → タスクを見て計画修正（プランモード）
6. 続行 or revert判断
```

### ブランチ構造

```
main ────────────────────────────────────
  \
   task-001 ─────────────────────────────
              \
               subtask-001 (細かくコミット)
                    │
                    ↓ 完了
               task-001にマージ、subtask-001削除
```

- サブタスクは基本1つ、異常時のみ増やす
- サブタスク内では細かくコミット（すぐ戻せるように）
- 完了したらtask-xxxにマージしてsubtaskブランチは削除

## 設計ポイント

### サンドボックス

目的: 並列化しても競合しない、失敗しても他に影響しない

実現手段（優先順）:
1. git worktree（軽量、推奨）
2. ディレクトリコピー
3. コンテナ
4. VM

git worktreeを基本とするが、git必須とするか代替手段も用意するかは検討。

### ガードレール（信頼ベース）

現時点では機械的強制ではなくSKILL.mdでの指示:

1. **スコープ**: 計画にない変更をしない
2. **暴走防止**: 無限ループ、大量生成を避ける
3. **コミット忘れ防止**: 作業途中で止めない、未コミット変更ありで終了しない

将来的に機械的ガードレール（pre-commitフック等）を追加可能な設計に。

### 計画確定の明示

プランモードで対話 → 指示者（ユーザー or プロジェクトリーダースキル使用agent）が「OK」「go」等で確定。

### タスク定義の形式

検討事項:
- ファイル形式（md? yaml? ハイブリッド?）
- 保存場所（.tasks/ ディレクトリ?）
- 状態管理（別ファイル or 同一ファイル内）

Claude Code Actionとの類似性を参考に設計。

## Claude Code Action との関係

| 観点 | Claude Code Action | タスクスキル |
|------|-------------------|--------------|
| トリガー | GitHub Event | 指示者 |
| 環境 | GitHubランナー | git worktree等 |
| コンテキスト | Issue/PR内容 | タスク定義ファイル |
| 結果出力 | GitHub | ブランチマージ + 報告 |

方向性は類似。Claude Code Actionが「GitHub特化」なら、タスクスキルは「汎用タスク実行パターン」。

## async-shellとの連携

タスク実行環境としてasync-shellを使用:

1. **サブエージェント起動**: タスク実行用のClaude CLIを別ウィンドウで起動
2. **状態確認**: capture（ただしポーリング最小化のためファイルベース結果受け渡しを併用推奨）
3. **入力送信**: type + submit

### ポーリング問題への対応

captureを繰り返すとコンテキストが膨らむ。

対策案:
- 結果をファイルに書き出し、完了フラグファイルで判定
- `[ -f /tmp/task_${ID}.status ] && cat /tmp/task_${ID}.result`

## 検討が必要な項目

1. タスク定義ファイルの具体的形式
2. 完了条件の定義方法
3. 異常時の具体的なフロー
4. 複数タスク管理（本スキルの責務外だが、上位スキルとの接点）

## 注意事項

- 複数タスクへの分割、タスク間の依存関係管理はこのスキルの責務外
- 単一タスクの完了に集中する
